name: ğŸš€ Build IA DERIV AvanÃ§ada

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  FORCE_COLOR: true
  NODE_VERSION: '20.x'

jobs:
  # Job de testes e validaÃ§Ã£o
  test:
    name: ğŸ§ª Testes e ValidaÃ§Ã£o
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        npm ci --no-optional --no-fund --no-audit
        
    - name: ğŸ”§ Criar assets
      run: npm run create-assets
      
    - name: ğŸ§ª Executar testes
      run: |
        echo "âœ… ValidaÃ§Ã£o de sintaxe"
        node -c main.js
        node -c preload.js
        
    - name: ğŸ“Š Verificar package.json
      run: npm run --if-present test
      
    - name: ğŸ“‹ Lint (se configurado)
      run: npm run --if-present lint
      continue-on-error: true

  # Job de build para Windows
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    needs: test
    
    strategy:
      matrix:
        arch: [x64, ia32]
        
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        npm ci --no-optional --no-fund --no-audit
        
    - name: ğŸ”§ Criar assets
      run: npm run create-assets
      
    - name: ğŸ—ï¸ Build aplicaÃ§Ã£o
      run: |
        if ("${{ matrix.arch }}" -eq "x64") {
          npm run build-win-64
        } else {
          npm run build-win-32
        }
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“Š Verificar artefatos
      run: |
        Write-Host "ğŸ“ ConteÃºdo do diretÃ³rio dist:"
        Get-ChildItem -Path "dist" -Recurse | ForEach-Object {
          $size = if ($_.PSIsContainer) { "[DIR]" } else { "$([math]::Round($_.Length / 1MB, 2)) MB" }
          Write-Host "  $($_.Name) - $size"
        }
        
    - name: ğŸ“¤ Upload artefatos
      uses: actions/upload-artifact@v4
      with:
        name: ia-deriv-windows-${{ matrix.arch }}
        path: |
          dist/*.exe
          dist/*.zip
        retention-days: 30

  # Job de build portÃ¡til
  build-portable:
    name: ğŸ“¦ Build PortÃ¡til
    runs-on: windows-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci --no-optional
      
    - name: ğŸ”§ Criar assets
      run: npm run create-assets
      
    - name: ğŸ“± Build versÃ£o portÃ¡til
      run: npm run build-portable
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¤ Upload versÃ£o portÃ¡til
      uses: actions/upload-artifact@v4
      with:
        name: ia-deriv-portable
        path: dist/*Portable*.exe
        retention-days: 30

  # Job de release (apenas para tags)
  release:
    name: ğŸš€ Release
    runs-on: windows-latest
    needs: [build-windows, build-portable]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download artefatos x64
      uses: actions/download-artifact@v4
      with:
        name: ia-deriv-windows-x64
        path: release/x64/
        
    - name: ğŸ“¥ Download artefatos ia32
      uses: actions/download-artifact@v4
      with:
        name: ia-deriv-windows-ia32
        path: release/ia32/
        
    - name: ğŸ“¥ Download versÃ£o portÃ¡til
      uses: actions/download-artifact@v4
      with:
        name: ia-deriv-portable
        path: release/portable/
        
    - name: ğŸ“ Gerar changelog
      id: changelog
      run: |
        $version = "${{ github.ref_name }}"
        $changelog = @"
        ## ğŸš€ IA DERIV AvanÃ§ada $version
        
        ### âœ¨ Novidades
        - Sistema de Q-Learning aprimorado
        - InversÃ£o adaptativa mais inteligente
        - Interface desktop otimizada para Windows
        - NotificaÃ§Ãµes nativas do sistema
        - Armazenamento local seguro de configuraÃ§Ãµes
        
        ### ğŸ”§ Melhorias
        - Performance otimizada para Windows 10/11
        - Atalhos de teclado completos
        - Sistema anti-duplicaÃ§Ã£o ultra rigoroso
        - Feedback automÃ¡tico para IA apÃ³s trades
        
        ### ğŸ“¦ Downloads DisponÃ­veis
        - **Setup Completo (64-bit)**: Instalador com todas as funcionalidades
        - **Setup Completo (32-bit)**: CompatÃ­vel com sistemas mais antigos  
        - **VersÃ£o PortÃ¡til**: NÃ£o requer instalaÃ§Ã£o, execute diretamente
        
        ### âš ï¸ Requisitos
        - Windows 10/11 (64-bit recomendado)
        - 4GB RAM mÃ­nimo
        - ConexÃ£o com internet para IA avanÃ§ada
        - Token de API da Deriv
        
        ### ğŸ”— Links Ãšteis
        - [Obter Token API](https://app.deriv.com/account/api-token)
        - [DocumentaÃ§Ã£o Completa](README.md)
        - [Suporte](https://github.com/ia-trading-team/ia-deriv-avancada/issues)
        
        **âš ï¸ IMPORTANTE**: Use sempre conta DEMO para testes. Trading envolve riscos financeiros.
        "@
        
        $changelog | Out-File -FilePath "CHANGELOG.md" -Encoding UTF8
        echo "changelog_content=$changelog" >> $env:GITHUB_OUTPUT
        
    - name: ğŸ·ï¸ Criar release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ğŸš€ IA DERIV AvanÃ§ada ${{ github.ref_name }}
        body: ${{ steps.changelog.outputs.changelog_content }}
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        files: |
          release/x64/*.exe
          release/ia32/*.exe
          release/portable/*.exe
          README.md
          LICENSE.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job de seguranÃ§a e qualidade
  security:
    name: ğŸ›¡ï¸ Auditoria de SeguranÃ§a
    runs-on: windows-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci --no-optional
      
    - name: ğŸ” Auditoria npm
      run: |
        Write-Host "ğŸ” Executando auditoria de seguranÃ§a..."
        npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas"
        
    - name: ğŸ“Š AnÃ¡lise de dependÃªncias
      run: |
        Write-Host "ğŸ“Š Analisando dependÃªncias..."
        npm ls --depth=0
        
    - name: ğŸ§¹ Verificar arquivos sensÃ­veis
      run: |
        Write-Host "ğŸ§¹ Verificando arquivos sensÃ­veis..."
        $sensitiveFiles = @("*.key", "*.pem", "*.p12", ".env*", "config.json")
        foreach ($pattern in $sensitiveFiles) {
          $files = Get-ChildItem -Path . -Name $pattern -Recurse -ErrorAction SilentlyContinue
          if ($files) {
            Write-Host "âš ï¸ Arquivos sensÃ­veis encontrados: $files"
          }
        }

  # Job de notificaÃ§Ã£o
  notify:
    name: ğŸ“¢ NotificaÃ§Ã£o
    runs-on: windows-latest
    needs: [build-windows, build-portable]
    if: always()
    
    steps:
    - name: ğŸ“¢ Status do build
      run: |
        $status = "${{ needs.build-windows.result }}"
        $portable = "${{ needs.build-portable.result }}"
        
        if ($status -eq "success" -and $portable -eq "success") {
          Write-Host "âœ… Build concluÃ­do com sucesso!"
          Write-Host "ğŸ‰ IA DERIV AvanÃ§ada estÃ¡ pronto para uso!"
        } else {
          Write-Host "âŒ Build falhou. Verifique os logs."
        }
        
        Write-Host "ğŸ“Š Resultados:"
        Write-Host "  Windows Build: $status"
        Write-Host "  Portable Build: $portable"
        Write-Host "  Commit: ${{ github.sha }}"
        Write-Host "  Branch: ${{ github.ref_name }}"